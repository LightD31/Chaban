# Exemple de configuration pour l'intégration Chaban Bridge

# Dans configuration.yaml (optionnel - l'intégration utilise Config Flow)
# chaban_bridge:

# Exemples d'automatisations pour sensors.yaml ou automations.yaml
automation:
  # Notification lors de la fermeture
  - alias: "Pont Chaban - Notification Fermeture"
    description: "Notification quand le pont se ferme"
    trigger:
      - platform: state
        entity_id: sensor.pont_chaban_delmas
        to: "closed"
    action:
      - service: notify.persistent_notification
        data:
          title: "🌉 Pont Chaban-Delmas"
          message: "Le pont est maintenant fermé pour {{ state_attr('sensor.pont_chaban_delmas', 'closures')[0].reason }}"

  # Alerte fermeture imminente (30 minutes)
  - alias: "Pont Chaban - Alerte Fermeture Imminente"
    description: "Alerte 30 minutes avant fermeture"
    trigger:
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: template
        value_template: >
          {% set closures = state_attr('sensor.pont_chaban_delmas', 'closures') %}
          {% if closures and closures|length > 0 %}
            {% set next_closure = closures[0]['start_date'] %}
            {% set now = now() %}
            {% set closure_time = strptime(next_closure, '%Y-%m-%dT%H:%M:%S') %}
            {% set time_diff = (closure_time - now).total_seconds() %}
            {{ time_diff > 0 and time_diff <= 1800 }}
          {% else %}
            false
          {% endif %}
    action:
      - service: notify.mobile_app_your_device
        data:
          title: "⚠️ Pont Chaban-Delmas"
          message: "Fermeture dans 30 minutes ! Raison: {{ state_attr('sensor.pont_chaban_delmas', 'closures')[0].reason }}"

# Exemple de template sensor pour affichage personnalisé
template:
  - sensor:
      - name: "Pont Chaban Status"
        state: >
          {% if states('sensor.pont_chaban_delmas') == 'closed' %}
            Fermé
          {% elif states('sensor.pont_chaban_delmas') == 'open' %}
            Ouvert
          {% else %}
            {{ states('sensor.pont_chaban_delmas') }}
          {% endif %}
        icon: >
          {% if state_attr('sensor.pont_chaban_delmas', 'is_closed') %}
            mdi:bridge-off
          {% else %}
            mdi:bridge
          {% endif %}

      - name: "Prochaine Fermeture Pont Chaban"
        state: >
          {% set closures = state_attr('sensor.pont_chaban_delmas', 'closures') %}
          {% if closures and closures|length > 0 %}
            {{ closures[0]['start_date'] | as_datetime | strftime('%d/%m à %H:%M') }}
          {% else %}
            Aucune fermeture prévue
          {% endif %}
        attributes:
          reason: >
            {% set closures = state_attr('sensor.pont_chaban_delmas', 'closures') %}
            {% if closures and closures|length > 0 %}
              {{ closures[0]['reason'] }}
            {% else %}
              N/A
            {% endif %}
          duration: >
            {% set closures = state_attr('sensor.pont_chaban_delmas', 'closures') %}
            {% if closures and closures|length > 0 %}
              {% set start = closures[0]['start_date'] | as_datetime %}
              {% set end = closures[0]['end_date'] | as_datetime %}
              {% set duration = (end - start).total_seconds() / 60 %}
              {{ duration | round(0) }} minutes
            {% else %}
              N/A
            {% endif %}
